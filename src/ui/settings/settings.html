<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
      crossorigin="anonymous"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Roboto:400,900"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.11/lodash.min.js"></script>
    <title>Sync Settings</title>
  </head>
  <body>
    <div style="height: 70px"></div>
    <div class="container">
      <div class="jumbotron">
        <h2 class="display-4">Sync Settings</h2>
        <hr class="my-4" />
        <form id="root"></form>
      </div>
    </div>
    <script
      src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
      integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
      integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
      integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
      crossorigin="anonymous"
    ></script>
    <script>
      String.prototype.replaceAll = function(search, replacement) {
        var target = this;
        return target.replace(new RegExp(search, "g"), replacement);
      };

      function appendHTML(parent, html) {
        var div = document.createElement("div");
        div.innerHTML = html;
        while (div.children.length > 0) {
          parent.appendChild(div.children[0]);
        }
        div.remove();
      }
    </script>
    <script>
      const settings = JSON.parse(`@CURRENT_DATA`);
      const settingsMap = JSON.parse(`@SETTINGS_MAP`);
      const vscode = acquireVsCodeApi();

      const textInputTemplate = `<div class="form-group">
            <label for="setting:@correspondingSetting"
              >@name</label
            >
            <input
              type="text"
              class="form-control text"
              id="setting:@correspondingSetting"
              placeholder="@placeholder"
              setting="@correspondingSetting"
            />
          </div>`;

      const checkboxTemplate = `<div class="custom-control custom-checkbox my-1 mr-sm-2">
            <input
              class="custom-control-input checkbox"
              type="checkbox"
              id="setting:@correspondingSetting"
              setting="@correspondingSetting"
            />
            <label for="setting:@correspondingSetting" class="custom-control-label">
              @name
            </label>
          </div>`;

      const textareaTemplate = `<div class="form-group">
            <label for="setting:@correspondingSetting"
              >@name</label
            >
            <textarea
              class="form-control textarea"
              id="setting:@correspondingSetting"
              rows="3"
              data-min-rows="3"
              placeholder="@placeholder"
              setting="@correspondingSetting"
            ></textarea>
          </div>`;

      const parent = document.getElementById("root");
      settingsMap.forEach(settingMap => {
        let template;
        switch (settingMap.type) {
          case 0:
            template = textInputTemplate;
            break;
          case 1:
            template = checkboxTemplate;
            break;
          case 2:
            template = textareaTemplate;
            break;
        }
        const html = template
          .replaceAll("@name", settingMap.name)
          .replaceAll("@placeholder", settingMap.placeholder)
          .replaceAll("@correspondingSetting", settingMap.correspondingSetting);
        appendHTML(parent, html);
      });

      $(document).ready(function() {
        $(".text")
          .each((i, el) => {
            $(el).val(_.get(settings, $(el).attr("setting")));
          })
          .change(function() {
            let val = $(this).val();
            vscode.postMessage({
              command: $(this).attr("setting"),
              text: val
            });
          });
        $(".checkbox")
          .each((i, el) => {
            $(el).prop("checked", _.get(settings, $(el).attr("setting")));
          })
          .change(function() {
            let val = $(this).is(":checked");
            vscode.postMessage({
              command: $(this).attr("setting"),
              text: val
            });
          });
        $(".textarea")
          .each((i, el) => {
            let str = "";
            _.get(settings, $(el).attr("setting")).forEach(
              item => (str += item + "\n")
            );
            $(el).val(str);
          })
          .change(function() {
            let val = [];
            $(this)
              .val()
              .split("\n")
              .forEach(item => {
                if (item !== "") {
                  val.push(item);
                }
              });
            vscode.postMessage({
              command: $(this).attr("setting"),
              text: val
            });
          });
      });
    </script>
    <style>
      html,
      body {
        background-color: rgb(37, 37, 37);
        font-family: "Roboto", sans-serif !important;
      }
      .jumbotron > .display-4 {
        font-weight: 900;
      }
    </style>
  </body>
</html>
